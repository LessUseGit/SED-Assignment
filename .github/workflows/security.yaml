name: Security

on:
  push:

jobs:
  pip-audit:
    name: Run pip-audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          pip install pip-audit

      - name: Dependency Check Strict (pip-audit)
        if: github.ref == 'refs/heads/main'
        run: |
          pip-audit --strict --format markdown > pip-audit.md
          echo "### Pip Audit Results" >> $GITHUB_STEP_SUMMARY
          cat pip-audit.md >> $GITHUB_STEP_SUMMARY

      - name: Dependency Check (pip-audit)
        if: github.ref != 'refs/heads/main'
        continue-on-error: true
        run: |
          pip-audit --format markdown > pip-audit.md
          echo "### Pip Audit Results" >> $GITHUB_STEP_SUMMARY
          cat pip-audit.md >> $GITHUB_STEP_SUMMARY

      - name: Upload pip-audit report
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit.md

  sast:
    name: Run Semgrep (sast)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep
        run: |
          semgrep --config=auto --json > semgrep-report.json || true
          echo "### Semgrep Results" >> $GITHUB_STEP_SUMMARY
          semgrep --config=auto | tail -n 10 >> $GITHUB_STEP_SUMMARY

      - name: Upload Semgrep Report
        uses: actions/upload-artifact@v4
        with:
          name: Semgrep Report
          path: semgrep-report.json

  # zap_scan:
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout Repository
  #       uses: actions/checkout@v4

  #     - name: Build & Run Application
  #       run: |
  #         docker build -t fastapi-app .
  #         docker run -d -p 80:80 --name fastapi-container fastapi-app
      
  #     - name: ZAP Scan
  #       uses: zaproxy/action-full-scan@v0.12.0
  #       with:
  #         target: "http://localhost:80"
  #         docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
  #         allow_issue_writing: false

  #     - name: Upload ZAP Report
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: zap-security-report
  #         path: zap-report.html

  #     - name: Stop and Remove Container
  #       run: docker stop fastapi-container && docker rm fastapi-container
